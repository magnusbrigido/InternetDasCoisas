<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>lux2</title>
    <script>
      luxGlobal = 0;
      //Chamada quando a aplicacao inicia
      function OnStart()
      {
          //criar layout centralizados verticalmente
          lay = app.CreateLayout( "linear", "VCenter,FillXY" );    

          //criar label texto e adiciona ao layout
          txt = app.CreateText( "Medindo lux" );
          txt.SetTextSize( 32 );
          lay.AddChild( txt );
          
          //adicionar o layout ao app    
          app.AddLayout( lay );
          
          sns = app.CreateSensor( "Light" );
          sns.SetOnChange( sns_OnChange );
          sns.Start();
          setInterval(sendToAPI, 10000);
      }

      function sns_OnChange( lux )
      {
        luxGlobal = lux;
      }

      function sendToAPI() {
        const http = new XMLHttpRequest()
        
        http.open("GET", "https://api.thingspeak.com/update?api_key=5363X35PX7GYKWW5&field1="+luxGlobal)
        http.send()
        http.onload = setLuxText(http.responseText, luxGlobal)
      }

      function setLuxText(resp,lux) {
          txt.SetText( resp +" level = " + lux + " lux" );
      }
        
    </script>
  </head>
         
  <body>
    <iframe width="450" height="260" style="border: 1px solid #cccccc;" src="https://thingspeak.com/channels/851479/charts/1?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=60&type=line&update=15"></iframe>
</html>
